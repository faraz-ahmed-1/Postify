<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile - Postify</title>
  <link rel="shortcut icon" href="FAVICON.png" type="image/x-icon">
  <style>
    :root{--bg:#f8f9fa;--white:#fff;--muted:#6b6b6b}
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#111}
    .layout{display:flex;min-height:100vh}
    .sidebar{width:240px;background:var(--white);border-right:1px solid #e6e6e6;padding:20px;box-sizing:border-box}
    .sidebar h2{margin:0 0 20px;font-size:20px}
    .sidebar ul{list-style:none;padding:0;margin:0}
    .sidebar li{margin:12px 0;cursor:pointer;font-weight:600;color:#222}
    .main{flex:1;padding:28px;box-sizing:border-box}

    .profile-header{display:flex;gap:32px;align-items:center;margin-bottom:22px}
    .profile-header .avatar{width:130px;height:130px;border-radius:50%;object-fit:cover;background:#ddd}
    .profile-details h2{margin:0;font-size:22px}
    .profile-stats{display:flex;gap:20px;margin:10px 0;color:var(--muted);font-weight:600}
    .follow-btn {
      margin-top: 20px;
      padding: 8px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      background: #111;
      color: #fff;
    }
    .follow-btn.unfollow { background:#ddd; color:#111; }

    .posts-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px; margin-top: 30px;}
    .posts-grid .media{width:100%;height:270px;object-fit:cover;border-radius:6px;cursor:pointer;display:block}
    .posts-grid video.media { background: #000; }

.likeBtn {
  font-size: 36px;
  cursor: pointer;
  border: none;
  background: none;
  color: #111;
  transition: color 0.15s ease;
  padding: 0;
  line-height: 1;
}

.likeBtn.liked {
  color: #e33; /* red when liked */
}

.likeBtn.pop {
  animation: pop 0.35s ease;
}

@keyframes pop {
  0%   { transform: scale(1); }
  40%  { transform: scale(1.4); }
  60%  { transform: scale(0.9); }
  100% { transform: scale(1); }
}


    @media (max-width:900px){ .sidebar{display:none} .posts-grid .media{height:180px} .profile-header{gap:16px} }


        /* Modal */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); z-index:9999; align-items:center; justify-content:center; padding:20px; }
    .modal.open { display:flex; }
    .modal-card { width:100%; max-width:1100px; height:80vh; display:flex; background:var(--white); border-radius:8px; overflow:hidden; }
    .modal-left{flex:1; display:flex; align-items:center; justify-content:center; background:#000}
    .modal-left img, .modal-left video{max-width:100%; max-height:100%; object-fit:contain}
    .modal-right{width:420px; box-sizing:border-box; display:flex; flex-direction:column; border-left:1px solid #eee}
    .post-header{display:flex; align-items:center; gap:12px;padding:12px 16px; border-bottom:1px solid #f0f0f0}
    .post-header img{width:40px;height:40px;border-radius:50%;object-fit:cover}
    .post-body{flex:1; overflow:auto; padding:12px 16px;}
    .caption{margin:8px 0;color:#222}
    .likes-row{padding:10px 16px;border-top:1px solid #f0f0f0}
    .actions{display:flex;gap:12px;padding:10px 16px;align-items:center;border-top:1px solid #f7f7f7}
    .comments{display:flex;flex-direction:column;gap:10px}
    .comment{display:flex;gap:8px;align-items:flex-start}
    .comment img{width:34px;height:34px;border-radius:50%;object-fit:cover}
    .comment-text{background:#f2f2f2;padding:8px 10px;border-radius:10px}
    .add-comment{display:flex;gap:8px;padding:10px 16px;border-top:1px solid #eee}
    .add-comment input{flex:1;padding:10px;border-radius:20px;border:1px solid #ddd}
    .add-comment button{padding:10px 14px;border-radius:20px;background:#111;color:#fff;border:none;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h2>Postify</h2>
      <ul>
        <li onclick="goToFeed()">Home</li>
        <li onclick="goToProfile()">Profile</li>
        <li onclick="logout()">Logout</li>
      </ul>
    </aside>

    <main class="main">
      <section class="profile-header">
        <img id="profilePic" class="avatar" src="/uploads/default.png" alt="avatar">
        <div class="profile-details">
          <h2 id="profileUsername">@username</h2>
          <div class="profile-stats">
            <div><span id="postCount">0</span> posts</div>
            <div><span id="followers">0</span> followers</div>
            <div><span id="following">0</span> following</div>
          </div>
          <div id="fullName" class="muted">Full Name</div>
          <div id="bio" style="margin-top:8px;color:#333">User bio</div>
          <button id="actionBtn" class="follow-btn"></button>
        </div>
      </section>

      <section>
        <div id="posts-container" class="posts-grid"></div>
      </section>
    </main>
  </div>

<script>
  const API = "http://localhost:3000/api";
  const params = new URLSearchParams(window.location.search);
  const username = params.get("user"); // profile being viewed
  // const currentUser = localStorage.getItem("username"); // logged-in user (store at login)
  const currentUser = JSON.parse(localStorage.getItem("user"));


const usernameEl = document.getElementById("profileUsername"); // correct ID
const fullNameEl = document.getElementById("fullName");
const bioEl = document.getElementById("bio");
const profilePicEl = document.getElementById("profilePic"); // correct ID
const followBtn = document.getElementById("actionBtn"); // correct ID

let profileUserId = null; 
  async function loadProfile() {
    try {
      // const res = await fetch(`${API}/profile?username=${username}&currentUser=${currentUser}`);
      const res = await fetch(`${API}/profile?username=${username}&currentUserId=${currentUser.id}`);
      const data = await res.json();

      if (!res.ok) throw new Error(data.error);

      document.getElementById('postCount').textContent = data.postCount ?? 0;
      document.getElementById('followers').textContent = data.followers ?? 0;
      document.getElementById('following').textContent = data.following ?? 0;
      usernameEl.innerText = "@" + data.username;
      fullNameEl.innerText = data.full_name;
      bioEl.innerText = data.bio || "";
      profilePicEl.src = data.profile_pic || "default.png";

      // set follow/unfollow button
      if (username !== currentUser) {
        followBtn.style.display = "block";
        followBtn.innerText = data.isFollowed ? "Following" : "Follow";
        followBtn.onclick = () => toggleFollow(
  currentUser.user_id,   // follower
  profileUserId,         // following
  followBtn,             // button element
  document.getElementById("followers") // count element
);

      } else {
        followBtn.style.display = "none"; // hide button on own profile
      }

      profileUserId = data.user_id;   // save backendâ€™s user_id for follow/unfollow
          // after profile info is set:
    loadPosts(username);

    } catch (err) {
      console.error("Error loading profile:", err);
    }

  }

async function toggleFollow(followerId, followingId, buttonEl, countEl) {
  const isFollowing = buttonEl.innerText === "Following";

  try {
    let res;
    if (isFollowing) {
      res = await fetch(`${API}/follow?follower_id=${followerId}&following_id=${followingId}`, {
        method: "DELETE"
      });
    } else {
      res = await fetch(`${API}/follow`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ follower_id: followerId, following_id: followingId })
      });
    }

    const data = await res.json();

    if (data.success) {
      buttonEl.innerText = isFollowing ? "Follow" : "Following";
      if (countEl) countEl.innerText = data.followerCount; // âœ… update from server
    } else {
      console.error("Follow API failed:", data.message);
    }
  } catch (err) {
    console.error("Network error:", err);
  }
}

loadProfile();

// let profileUserId = null; // store profile's user_id

  async function loadPosts(username) {
  try {
    const res = await fetch(`${API}/user-posts/${username}`);
    const posts = await res.json();

    if (!res.ok) throw new Error(posts.error);

    const container = document.getElementById("posts-container");
    container.innerHTML = ""; // clear old posts

    if (!posts.length) {
      container.innerHTML = "<p style='color:#666'>No posts yet.</p>";
      return;
    }

    posts.forEach(post => {
      const mediaEl = document.createElement(post.image_url ? "img" : "video");
      mediaEl.className = "media";
      mediaEl.src = post.image_url || post.video_url;
      if (post.media_type === "video") mediaEl.controls = true;

      // click â†’ open modal with details
      mediaEl.onclick = () => openPostModal(post);

      container.appendChild(mediaEl);
      mediaEl.onclick = () => openPostModal(post);

    });
  } catch (err) {
    console.error("Error loading posts:", err);
  }
}

function formatLikes(likers) {
  const total = likers.length;
  if (total === 0) return "";
  if (total === 1) return `Liked by ${likers[0].username}`;
  if (total === 2) return `Liked by ${likers[0].username} and ${likers[1].username}`;
  return `Liked by ${likers[0].username} and others`;
}


async function openPostModal(post) {
  const postId = post.post_id; // âœ… correct field from DB
  const modal = document.getElementById("postModal");
  const modalLeft = document.getElementById("modal-left");
  modal.style.display = "flex";

  // reset left
  modalLeft.innerHTML = "";
  let mediaEl;
  if (post.video_url) {
    mediaEl = document.createElement("video");
    mediaEl.src = post.video_url;
    mediaEl.controls = true;
  } else {
    mediaEl = document.createElement("img");
    mediaEl.src = post.image_url;
  }
  mediaEl.style.maxWidth = "100%";
  mediaEl.style.maxHeight = "100%";
  modalLeft.appendChild(mediaEl);

  // Header
  document.getElementById("modalAuthorPic").src = post.profile_pic || "/uploads/default.png";
  document.getElementById("modalAuthor").innerText = "@" + post.username;
  document.getElementById("modalTime").innerText = new Date(post.created_at).toLocaleString();

  // Caption
  document.getElementById("modalCaptionAuthor").innerText = "@" + post.username;
  document.getElementById("modalCaption").innerText = post.content || "";

  // ... rest of code ...

  // ðŸ‘‰ Load likes
  try {
    const resLikes = await fetch(`${API}/post/${post.id}/likes?username=${currentUser.username}`);
    const likesData = await resLikes.json();

    const likeBtn = document.getElementById("modalLikeBtn");
    const likeCountText = document.getElementById("likeCountText");
    const likedBySmall = document.getElementById("likedBySmall");

    // set initial UI
    likeCountText.innerText = (likesData.likeCount || 0);
    likeBtn.classList.toggle("liked", likesData.liked);
    likeBtn.innerText = likesData.liked ? "â¤" : "â™¡";
    likedBySmall.innerText = formatLikes(likesData.likers);

    // ðŸ‘‰ toggle like/unlike
    likeBtn.onclick = async () => {
      try {
        await fetch(`${API}/like`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            username: currentUser.username,
            postId: post.id
          })
        });

        // reload likes after like/unlike
        const resLikes2 = await fetch(`${API}/post/${post.id}/likes?username=${currentUser.username}`);
        const likesData2 = await resLikes2.json();

        likeCountText.innerText = (likesData2.likeCount || 0);
        likeBtn.classList.toggle("liked", likesData2.liked);
        likeBtn.innerText = likesData2.liked ? "â¤" : "â™¡";
        likedBySmall.innerText = formatLikes(likesData2.likers);

      } catch (err) {
        console.error("Error toggling like:", err);
      }
    };
  } catch (err) {
    console.error("Error loading likes:", err);
  }

  // ðŸ‘‰ Load comments with postId
  try {
    const resComments = await fetch(`${API}/post/comments/${post.id}`);
    const comments = await resComments.json();

    const commentsList = document.getElementById("commentsList");
    commentsList.innerHTML = "";
    comments.forEach(c => {
      const div = document.createElement("div");
      div.classList.add("comment");
      div.innerHTML = `
        <img src="${c.profile_pic || "/uploads/default.png"}" alt="">
        <div class="comment-text">
          <b>@${c.username}</b> ${c.comment}
          <div class="muted">${new Date(c.created_at).toLocaleString()}</div>
        </div>
      `;
      commentsList.appendChild(div);
    });

    document.getElementById("commentCountText").innerText = comments.length;
  } catch (err) {
    console.error("Error loading comments:", err);
  }

  document.getElementById("modalCommentBtn").onclick = () => handleModalComment(post.id);
}


async function handleModalComment(postId) {
  const text = document.getElementById("modalCommentInput").value.trim();
  if (!text) return;

  try {
    await fetch(`${API}/comment`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username: currentUser.username,
        postid: postId,
        comment: text
      }),
    });

    document.getElementById("modalCommentInput").value = "";

    // âœ… reload comments directly instead of calling a missing function
    const resComments = await fetch(`${API}/post/comments/${postId}`);
    const comments = await resComments.json();
    const commentsList = document.getElementById("commentsList");
    commentsList.innerHTML = "";
    comments.forEach(c => {
      const div = document.createElement("div");
      div.classList.add("comment");
      div.innerHTML = `
        <img src="${c.profile_pic || "/uploads/default.png"}" alt="profile">
        <div class="comment-text">
          <b>@${c.username}</b> ${c.comment}
          <div class="muted">${new Date(c.created_at).toLocaleString()}</div>
        </div>
      `;
      commentsList.appendChild(div);
    });
    document.getElementById("commentCountText").innerText = comments.length;

  } catch (err) {
    console.error("Error adding comment:", err);
  }
}


function closePostModal() {
  document.getElementById("postModal").style.display = "none";
}

// Like/Unlike a post
async function handleLike(postId, username) {
  try {
    const res = await fetch("/api/like", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        user_id: currentUser.user_id,
        post_id: postId   // âœ… use postId (not post.id undefined here)
      }),
    });

    const data = await res.json();
    console.log(data.message);

    // refresh like count + button UI
    loadLikes(postId, username);
  } catch (err) {
    console.error("Error liking post:", err);
  }
}

// Refresh likes
async function loadLikes(postId, username) {
  try {
    const res = await fetch(`/api/post/${postId}/likes?username=${username}`);
    const data = await res.json();

    // update like count
    document.querySelector(`#likes-count-${postId}`).innerText = `${data.likeCount} likes`;

    // update like button
    const likeBtn = document.querySelector(`#like-btn-${postId}`);
    likeBtn.innerText = data.liked ? "â¤" : "â™¡";
    likeBtn.classList.toggle("liked", data.liked); // âœ… toggle red style
  } catch (err) {
    console.error("Error loading likes:", err);
  }
}


// Add a comment
async function handleComment(postId) {
  const text = document.querySelector(`#comment-input-${postId}`).value.trim();
  if (!text) return alert("Enter a comment!");

  try {
    const res = await fetch("${API}/comment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: currentUser.user_id,
        post_id: postId,
        comment: text
      }),
    });

    const data = await res.json();
    console.log(data.message);

    document.querySelector(`#comment-input-${postId}`).value = "";
    loadComments(postId);
  } catch (err) {
    console.error("Error adding comment:", err);
  }
}


// Load comments
async function loadComments(postId) {
  try {
    const res = await fetch(`/api/post/comments/${postId}`);
    const comments = await res.json();

    const container = document.querySelector(`#comments-${postId}`);
    container.innerHTML = comments
      .map(
        (c) =>
          "<p><b>${c.username}</b>: ${c.comment} <small>${new Date(c.created_at).toLocaleString()}</small></p>"
      )
      .join("");
  } catch (err) {
    console.error("Error loading comments:", err);
  }
}

function goToFeed(){ window.location.href='home.html'; }
function goToProfile(){ window.location.href='profile.html'; }
function logout(){ localStorage.removeItem('user'); window.location.href='index.html'; }

</script>

<!-- Post Modal -->
<!-- Post Modal -->
<div id="postModal" class="modal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.7); align-items:center; justify-content:center; z-index:10000;">
  <div class="modal-card" id="modal-card"
       style="background:#fff; border-radius:8px; max-width:900px; width:95%; display:flex; overflow:hidden;">
    
    <!-- Left: Media -->
    <div class="modal-left" id="modal-left" 
         style="flex:1; background:#000; display:flex; align-items:center; justify-content:center;">
    </div>

    <!-- Right: Post Details -->
    <div class="modal-right" style="flex:1; display:flex; flex-direction:column; max-height:90vh;">
      
      <!-- Header -->
      <div class="post-header" style="display:flex; align-items:center; gap:10px; padding:12px; border-bottom:1px solid #eee;">
        <img id="modalAuthorPic" src="/uploads/default.png" alt="author"
             style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
        <div>
          <div id="modalAuthor" style="font-weight:700">username</div>
          <div id="modalTime" style="font-size:12px; color:#666">time</div>
        </div>
        <button onclick="closePostModal()" 
                style="margin-left:auto; font-size:20px; border:none; background:none; cursor:pointer;">âœ•</button>
      </div>
      
      <!-- Comments List -->
<div class="post-body">
  <div id="commentsList" class="comments"></div>
</div>

<!-- Caption + Likes -->
<div class="likes-row">
  <div class="caption muted">
    <strong id="modalCaptionAuthor"></strong>
    <span id="modalCaption" style="font-weight:400"></span>
  </div>
</div>

<!-- Actions -->
<div class="actions modal-action">
  <button id="modalLikeBtn" class="likeBtn">â™¡</button>
  <div id="likeCountText" style="font-weight:600;">0</div>
  <button id="focusCommentBtn">ðŸ’¬</button>
  <div id="commentCountText" style="font-weight:600;">0</div>
  <div id="likedBySmall" class="muted" style="margin-left: 10px;"></div>
</div>

<!-- Add Comment -->
<div class="add-comment">
  <input id="modalCommentInput" placeholder="Add a comment..." />
  <button id="modalCommentBtn">Post</button>
</div>

    </div>
  </div>
</div>

</body>
</html>